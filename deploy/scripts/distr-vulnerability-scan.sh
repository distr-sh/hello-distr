#!/usr/bin/env bash
set -euo pipefail

# Scan hello-distr services for known vulnerabilities using osv-scanner.
#
# Usage:
#   ./deploy/scripts/distr-vulnerability-scan.sh                  # Local mode: scan lockfiles + local images
#   ./deploy/scripts/distr-vulnerability-scan.sh ci <VERSION>      # CI mode: scan lockfiles + registry images
#
# Local mode:  scans lockfiles (requirements.txt, package-lock.json) and
#              container images tagged :local (build with docker build -t ...:local).
#              Produces vulnerability-scan.json and vulnerability-scan.md.
# CI mode:     scans lockfiles AND registry container images for a given VERSION.
#              Produces vulnerability-scan.json and vulnerability-scan.md.
#
# All 4 services (backend, frontend, proxy, jobs) are always included in the report.

REPORT_FILE="vulnerability-scan.md"
JSON_FILE="vulnerability-scan.json"

CONTAINER_REGISTRY="ghcr.io/distr-sh/hello-distr"
ALL_SERVICES=("backend" "frontend" "proxy" "jobs")

# Services that have scannable lockfiles (service -> lockfile path)
declare -A SERVICE_LOCKFILES=(
  [backend]="backend/requirements.txt"
  [frontend]="frontend/package-lock.json"
)

HAS_VULNS=0

run_osv_scanner() {
  if command -v osv-scanner &>/dev/null; then
    osv-scanner "$@"
  else
    echo "ERROR: osv-scanner not found. Install via: mise install" >&2
    return 1
  fi
}

# Map CVSS score to severity label with emoji.
# CVSS ranges: CRITICAL 9.0-10.0, HIGH 7.0-8.9, MEDIUM 4.0-6.9, LOW 0.1-3.9
severity_label() {
  local score="${1:-0}"
  # Handle empty or non-numeric scores
  if [ -z "$score" ] || ! awk "BEGIN {exit !($score + 0 == $score)}" 2>/dev/null; then
    echo "âšª NONE"
    return
  fi
  if awk "BEGIN {exit !($score >= 9.0)}"; then
    echo "ðŸ”´ CRITICAL"
  elif awk "BEGIN {exit !($score >= 7.0)}"; then
    echo "ðŸŸ  HIGH"
  elif awk "BEGIN {exit !($score >= 4.0)}"; then
    echo "ðŸŸ¡ MEDIUM"
  elif awk "BEGIN {exit !($score > 0)}"; then
    echo "ðŸŸ¢ LOW"
  else
    echo "âšª NONE"
  fi
}

# Scan a lockfile for vulnerabilities.
# Produces vulnerability-scan-source-{service}.json.
# Returns 0 if clean, 1 if vulnerabilities found.
scan_lockfile() {
  local service="$1"
  local lockfile="$2"
  local output_file="vulnerability-scan-source-${service}.json"

  echo "Scanning ${service} lockfile: ${lockfile}..."

  if [ ! -f "$lockfile" ]; then
    echo "  SKIP: lockfile not found at ${lockfile}"
    return 0
  fi

  local exit_code=0
  run_osv_scanner scan -L "$lockfile" --format json --output "$output_file" || exit_code=$?

  if [ "$exit_code" -eq 0 ]; then
    echo "  CLEAN: no vulnerabilities found"
    [ -f "$output_file" ] || echo '{"results":[]}' > "$output_file"
    return 0
  elif [ "$exit_code" -eq 1 ]; then
    echo "  FOUND: vulnerabilities detected (see report)"
    return 1
  else
    echo "  WARN: osv-scanner exited with code ${exit_code}"
    [ -f "$output_file" ] || echo '{"results":[]}' > "$output_file"
    return 0
  fi
}

# Scan a container image for vulnerabilities.
# Produces vulnerability-scan-image-{service}.json.
# Returns 0 if clean, 1 if vulnerabilities found.
scan_image() {
  local service="$1"
  local image="$2"
  local output_file="vulnerability-scan-image-${service}.json"

  echo "Scanning ${service} container image: ${image}..."

  # Check if image exists locally
  if ! docker image inspect "$image" &>/dev/null; then
    echo "  SKIP: image not found (build with: docker build -t ${image} ./${service})"
    echo '{"results":[]}' > "$output_file"
    return 0
  fi

  local exit_code=0
  run_osv_scanner scan image "$image" --format json --output "$output_file" || exit_code=$?

  if [ "$exit_code" -eq 0 ]; then
    echo "  CLEAN: no vulnerabilities found"
    [ -f "$output_file" ] || echo '{"results":[]}' > "$output_file"
    return 0
  elif [ "$exit_code" -eq 1 ]; then
    echo "  FOUND: vulnerabilities detected (see report)"
    return 1
  else
    echo "  WARN: osv-scanner exited with code ${exit_code}"
    [ -f "$output_file" ] || echo '{"results":[]}' > "$output_file"
    return 0
  fi
}

# Generate unified markdown report from all vulnerability-scan-*.json files.
generate_report() {
  local mode="$1"
  local scan_files
  mapfile -t scan_files < <(find . -maxdepth 1 -name 'vulnerability-scan-*.json' -type f | sort)

  if [ ${#scan_files[@]} -eq 0 ]; then
    echo "No scan results found."
    echo '{"results":[]}' > "$JSON_FILE"
    echo "# Vulnerability Scan Report" > "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "No scan results found." >> "$REPORT_FILE"
    return
  fi

  # Merge all scan JSON files into a single JSON array
  jq -s '.' "${scan_files[@]}" > "$JSON_FILE"

  {
    echo "# Vulnerability Scan Report"
    echo ""
    echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)"
    echo "**Mode:** ${mode}"
    echo ""

    # Scanned dependencies overview â€” always show both image and source counts per service
    echo "## Scanned Dependencies"
    echo ""
    echo "| Service | Image | Source |"
    echo "|---------|-------|--------|"

    for service in "${ALL_SERVICES[@]}"; do
      local img_count src_count
      local img_file="./vulnerability-scan-image-${service}.json"
      local src_file="./vulnerability-scan-source-${service}.json"
      img_count=$(jq '[.results[]?.packages[]?] | length' "$img_file" 2>/dev/null || echo "â€“")
      if [ -f "$src_file" ]; then
        src_count=$(jq '[.results[]?.packages[]?] | length' "$src_file" 2>/dev/null || echo "0")
      else
        src_count="â€“"
      fi
      echo "| ${service} | ${img_count} | ${src_count} |"
    done

    echo ""

    # Summary table
    echo "## Summary"
    echo ""
    echo "| Service | Source | Scanned | Critical | High | Medium | Low | Total |"
    echo "|---------|--------|---------|----------|------|--------|-----|-------|"

    for f in "${scan_files[@]}"; do
      local fname
      fname=$(basename "$f" .json)
      # Filename format: vulnerability-scan-source-backend or vulnerability-scan-image-frontend
      local scan_type="${fname#vulnerability-scan-}"  # source-backend or image-frontend
      local source_kind="${scan_type%%-*}"             # source or image
      local service="${scan_type#*-}"                  # backend or frontend

      local source_label
      if [ "$source_kind" = "source" ]; then
        source_label="${SERVICE_LOCKFILES[$service]:-lockfile}"
      else
        source_label="container image"
      fi

      # Count scanned packages/dependencies
      local scanned
      scanned=$(jq '[.results[]?.packages[]?] | length' "$f" 2>/dev/null || echo "0")

      # Count vulnerabilities by CVSS severity ranges (empty max_severity defaults to 0)
      local critical high medium low total
      critical=$(jq '[.results[]?.packages[]?.groups[]? | (.max_severity | if . == "" then 0 else tonumber end) as $s | select($s >= 9.0)] | length' "$f" 2>/dev/null || echo "0")
      high=$(jq '[.results[]?.packages[]?.groups[]? | (.max_severity | if . == "" then 0 else tonumber end) as $s | select($s >= 7.0 and $s < 9.0)] | length' "$f" 2>/dev/null || echo "0")
      medium=$(jq '[.results[]?.packages[]?.groups[]? | (.max_severity | if . == "" then 0 else tonumber end) as $s | select($s >= 4.0 and $s < 7.0)] | length' "$f" 2>/dev/null || echo "0")
      low=$(jq '[.results[]?.packages[]?.groups[]? | (.max_severity | if . == "" then 0 else tonumber end) as $s | select($s > 0 and $s < 4.0)] | length' "$f" 2>/dev/null || echo "0")
      total=$((critical + high + medium + low))

      echo "| ${service} | ${source_label} | ${scanned} | ${critical} | ${high} | ${medium} | ${low} | ${total} |"
    done

    echo ""

    # Per-scan detail sections
    for f in "${scan_files[@]}"; do
      local fname
      fname=$(basename "$f" .json)
      local scan_type="${fname#vulnerability-scan-}"
      local source_kind="${scan_type%%-*}"
      local service="${scan_type#*-}"

      local source_label
      if [ "$source_kind" = "source" ]; then
        source_label="${SERVICE_LOCKFILES[$service]:-lockfile}"
      else
        source_label="container image"
      fi

      local vuln_count scanned_count
      vuln_count=$(jq '[.results[]?.packages[]?.groups[]?] | length' "$f" 2>/dev/null || echo "0")
      scanned_count=$(jq '[.results[]?.packages[]?] | length' "$f" 2>/dev/null || echo "0")

      echo "## ${service} (${source_label})"
      echo ""
      echo "**Scanned dependencies:** ${scanned_count}"
      echo ""

      if [ "$vuln_count" -eq 0 ]; then
        echo "No vulnerabilities found."
        echo ""
        continue
      fi

      echo "| ID | Package | Version | Severity | Summary |"
      echo "|----|---------|---------|----------|---------|"

      # List each vulnerability group with its details
      jq -r '
        .results[]?.packages[]? |
        .package as $pkg |
        .groups[]? |
        .max_severity as $sev |
        .ids[0] as $id |
        "\($id)\t\($pkg.name)\t\($pkg.version)\t\($sev)"
      ' "$f" 2>/dev/null | sort -u | while IFS=$'\t' read -r id pkg_name pkg_version severity; do
        [ -z "$id" ] && continue
        local label
        label=$(severity_label "$severity")
        echo "| ${id} | ${pkg_name} | ${pkg_version} | ${label} ${severity} | |"
      done

      echo ""
    done

    echo "---"
    echo ""
    if [ "$HAS_VULNS" -eq 1 ]; then
      echo "**Result: VULNERABILITIES FOUND**"
    else
      echo "**Result: CLEAN**"
    fi
    echo ""
    echo "---"
    echo ""
    echo "*Generated with [osv-scanner](https://github.com/google/osv-scanner)*"
  } > "$REPORT_FILE"
}

# --- Main ---

MODE="${1:-local}"
VERSION="${2:-local}"

# Clean up previous scan results
rm -f vulnerability-scan-source-*.json vulnerability-scan-image-*.json

# Scan lockfiles for services that have them
for service in "${!SERVICE_LOCKFILES[@]}"; do
  scan_lockfile "$service" "${SERVICE_LOCKFILES[$service]}" || HAS_VULNS=1
done

# Scan container images for all services
for service in "${ALL_SERVICES[@]}"; do
  scan_image "$service" "${CONTAINER_REGISTRY}/${service}:${VERSION}" || HAS_VULNS=1
done

generate_report "$MODE"

echo ""
if [ "$HAS_VULNS" -eq 1 ]; then
  echo "Vulnerabilities found. See ${REPORT_FILE} for details."
else
  echo "No vulnerabilities found. Report written to ${REPORT_FILE}"
fi
